# mailserver

## Installation (Ubuntu 18.04)

Before we start installing the system, start with the following commands to update the system:

    sudo apt -y update
    sudo apt -y upgrade

### Base dependencies
First, we will need install a few base dependencies:

    sudo apt -y install python3 python3-venv python3-dev mysql-server supervisor nginx git npm
    sudo apt -y install mailutils postfix-mysql mysql-server dovecot-core dovecot-imapd dovecot-pop3d dovecot-lmtpd dovecot-mysql

### Installing the application
Install the application through git:

    git clone https://github.com/AlenAlic/mailserver
    cd mailserver

### Backend
#### Dependencies
Create a virtualenv and activate it. Then install all the package dependencies in the virtualenv:

    python3 -m venv venv
    source venv/bin/activate
    pip install pip --upgrade
    pip install setuptools --upgrade
    pip install -r requirements.txt
    pip install gunicorn

#### Config
Create .env file.

    sudo nano .env

The file should contain at least the following variables:

    SECRET_KEY = "test-key"
    
    DATABASE_URI = "mysql+pymysql://mailuser:<db_password>@localhost:3306/mailserver?charset=utf8mb4"

    PRETTY_URL = "<domain>"
    
    ALLOWED_URLS = ["url_1", "url_2"]

You can create the SECRET_KEY for the website, and password for the MySQL database using the following command:

    python3 -c "import uuid; print(uuid.uuid4().hex)"

Save the config file (Ctrl+x, y, Enter).

Finally, you need to set the FLASK_APP environment variable in the system:

    export FLASK_APP=run.py
    echo "export FLASK_APP=run.py" >> ~/.profile
The second line sets it so that the command is automatically run when you log in.

#### Database
Enter the database with the following command:

    sudo mysql

Create a new database called **mailserver**, along with a user with the same name, that has full access to the database.

    CREATE DATABASE mailserver CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
    CREATE USER 'mailuser'@'localhost' IDENTIFIED BY '<db-password>';
    GRANT ALL PRIVILEGES ON mailserver.* TO 'mailuser'@'localhost';
    FLUSH PRIVILEGES;
    QUIT;

Make sure you replace *\<db-password>* with the password that was set in the *config.py* file.

Next, we need to initialize the database structure:

    flask db upgrade

#### Set up admin account for website
Before you can log in to the site, you will need to create the admin account (and floor manager account) through the shell:

    flask shell
    create_admin(email, password, first_name, last_name)
    exit()
    deactivate

#### Gunicorn
Gunicorn is a pure Python web server that will be used in stead of the built in Flask server.
Though in stead of running gunicorn directly, we'll let it run through the supervisor package.
Supervisor will then have it running in the background instead.
Should something happen to the server, or if the machine is rebooted, the server will be restarted on its own.

Create a file called *mailserver.conf* in the folder */etc/supervisor/conf.d/*

    sudo nano /etc/supervisor/conf.d/mailserver.conf

Copy the data from below into that file and replace *\<username>* with the username of the machine account.

    [program:mailserver]
    command=/home/<username>/mailserver/venv/bin/gunicorn -b 127.0.0.1:4000 -w 1 run:app
    directory=/home/<username>/mailserver
    user=<username>
    autostart=true
    autorestart=true
    stopasgroup=true
    killasgroup=true

After saving this file, reload the supervisor.

    sudo supervisorctl reload

The gunicorn web server should now be up and running on localhost:4000.

### SSL Certificate
To have our website accessible through HTTPS, we'll use Certbot to install a Let's Encrypt certificate.

To install Certbot, run the following commands.

    sudo apt install -y software-properties-common
    sudo add-apt-repository universe
    sudo add-apt-repository ppa:certbot/certbot

You will be prompted to install the certbot package. Press ENTER to proceed.

    sudo apt install -y certbot python-certbot-nginx

To install the certificate, use the following command.

    sudo certbot certonly --nginx -d <domain> -d <api_domain>

Now finally, go back to the nginx conf files, and uncomment the blocks regarding cretificates.
Then reload nginx.

    sudo service nginx reload


#### Nginx
Nginx is used to serve the pages that are generated by Gunicorn to the outside world.

Create a file called *\<domain>.conf* in the folder */etc/nginx/conf.d/*

    sudo nano /etc/nginx/conf.d/<domain>.conf

Copy the data from below into that file and replace *\<username>* with the username of the machine account.

    server {
        listen 443 ssl http2;
        server_name <domain>;

        location / {
            proxy_pass http://127.0.0.1:4000;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        access_log /var/log/<domain>_access.log;
        error_log /var/log/<domain>_error.log;
    
        ssl_certificate /etc/letsencrypt/live/<domain>/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/<domain>/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
        ssl_ecdh_curve secp521r1:secp384r1:prime256v1;

    }
    server {
        server_name <domain>;
        return 301 https://$request_uri;
    }


After saving this file, reload nginx:

    sudo service nginx reload


### Frontend

#### Config
Create a file called *config.json* in the folder */public/config/*.

    sudo nano public/config/config.json

Paste the api url in the file and save.

    {
        "api": {
            "url": ""
        }
    }


#### Build frontend

    npm install
    npm run build

#### Nginx
Nginx is used to serve the pages that are generated by Gunicorn to the outside world.

Create a file called *\<domain>.conf* in the folder */etc/nginx/conf.d/*

    sudo nano /etc/nginx/conf.d/<domain>.conf

Copy the data from below into that file and replace *\<username>* with the username of the machine account.

    server {
        listen 443 ssl http2;
        server_name <domain>;

        location / {
            root /home/<username>/mailserver/dist;
            index index.html;
            try_files $uri $uri/ /index.html;
        }
        
        access_log /var/log/<domain>_access.log;
        error_log /var/log/<domain>_error.log;
    
        ssl_certificate /etc/letsencrypt/live/<domain>/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/<domain>/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
        ssl_ecdh_curve secp521r1:secp384r1:prime256v1;
        
    }
    server {
        server_name <domain>;
        return 301 https://$host$request_uri;
    }

After saving this file, reload nginx:

    sudo service nginx reload

### Congratulations!

The frontend should be available on the local network through the local ip address of the machine you're on.

### Allow external access
If you wish to reach the site through the internet, you'll need a firewall and allow outside access to the server.

We'll install ufw (the Uncomplicated Firewall), and configure to allow external traffic on port 80 (http), and port 443 (https).

    sudo apt install -y ufw
    sudo ufw allow http
    sudo ufw allow https
    sudo ufw --force enable
